---
layout: post
title:  "Key Takeaways About Event Loop, Tasks and Microtasks"
date:   2018-02-18
tags:   
    -  Web Fundamental
---

Key points on event loop, tasks and microtasks:

1. Browser has one  main thread of JavaScript runtime, and several other threads running in background (web worker). JavaScript runtime is single-threaded.
2. Each thread gets its own event loop, and executes independently, whereas all windows on the same origin share an event loop as they can synchronously communicate.
3. The event loop runs continually, executing any tasks queued. Tasks are usually generated by Web APIs.
4. Example of tasks: `setTimeout`, `setInternal`, `setImmediate`, `message channel` and I/O tasks (DOM event and HTTP request).
5. Example of microtasks: `promise` and `mutation observer`.
6. Browser render steps are (JavaScript ->) style calculation -> layout -> paint. Browser could run render between tasks. Usually tasks finishes first then browser runs render, but certain properties or methods will trigger the browser to synchronously calculate the style and layout ([this gist](https://gist.github.com/paulirish/5d52fb081b3570c81e3a)), which causes performance issue.
7. `requestAnimationFrame` is within the render steps (rAF -> S -> L -> P). It is not a task. It is always before style calculation. (Safari currently puts rAF as the last step of render, which is a bug. Chrome and Firefox are doing fine.)
8. Render always executes at the beginning of each frame. Task can happen anytime during one frame.
9. Microtasks execute in order, and are executed: after every callback, as long as no other JavaScript is mid-execution, or at the end of each task.
10. In one loop, only one task can be processed. In one frame, animation callback queues executes to completion, but except the ones queued in this frame, which are deferred to the next frame. When microtasks are processed, microtask queue is processed to completion including any additional mircotask queued within this time.
11. Event triggering and bubbling is asynchronous, as all I/O tasks. Microtasks can happen in between the same event bubbling to its parent. But pay attention to JavaScript emulating event, as it can be synchronous.


#### References:
1. [Jake Archibald: In The Loop](https://www.youtube.com/watch?v=cCOL7MC4Pl0)
2. [Tasks, microtasks, queues and schedules](https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/)