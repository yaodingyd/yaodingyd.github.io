<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Yao's Blog</title>
  <meta name="description" content="Yao's blog on everything about web technologies'">

  <link rel="stylesheet" href="/public/css/main.css">
  <link rel="canonical" href="https://yaodingyd.github.io/">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/themes/black/pace-theme-flash.min.css" />
  
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://yaodingyd.github.io">
  <meta property="og:title" content="Yao's Blog">
  <meta property="og:image" content="">
  <meta property="og:description" content="Yao's blog on everything about web technologies">
  <meta property="og:site_name" content="Yao's Blog">
  <meta property="og:locale" content="en_US">
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@">
  <meta name="twitter:creator" content="@YaoDingSD">
  <meta name="twitter:url" content="https://yaodingyd.github.io">
  <meta name="twitter:title" content="Yao's Blog">
  <meta name="twitter:description" content="Yao's blog on everything about web technologies">
  <meta name="twitter:image" content="https://example.com/image.jpg">


  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-86352654-1', 'auto');
  ga('send', 'pageview');
  </script>
</head>

  <body class="site">

        <header class="header" role="banner">
    <a class="header__avatar" href="/">
        <img class="header__avatar-img" src="/resource/avatar.jpg">
    </a>
    <nav class="header__nav">
        <a class="header__nav-link" href="/">Blog</a>
        <a class="header__nav-link" href="/project/">Project</a>
        <a class="header__nav-link" href="/about/">About</a>
    </nav>
</header>

        <main id="barba-wrapper" class="site__content" aria-label="Content">
          <div class="barba-container">
          <div class="container">
  <article class="post" itemtype="http://schema.org/BlogPosting">  
    <header class="post__header">
      <h1 class="title" itemprop="name headline">Passport Authentication with JWT and Facebook-login</h1>
      <div class="post__meta">
        <time class="post__time">Feb 21, 2017</time>
          
          
            <a href="/tag#node" class="post__tag">Node</a>
          
        
      </div>
    </header>

    <div class="post__content" itemprop="articleBody">
      <p>JSON Web Token(JWT)s are usually stored in localStorage and do authentication for SPAs. With JWT, when using Passport to do authentication, we donâ€™t have to use session because JWT is stateless.</p>

<p>The node implementation is <code class="highlighter-rouge">jsonwebtoken</code>. We use <code class="highlighter-rouge">jsonwebtoken</code> to sign a token, which should be sent back to client side, and SPA would store it in localStorage. Express uses middleware <code class="highlighter-rouge">express-jwt</code> to validation JWT.</p>

<p>For example, if we use <code class="highlighter-rouge">passport-local</code> stragey, so</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="c1">// login stragey</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">Strategy</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'passport-local'</span>
<span class="kr">import</span> <span class="nx">bcrypt</span> <span class="nx">from</span> <span class="s1">'bcrypt-nodejs'</span>
<span class="kr">import</span> <span class="nx">dbConnection</span> <span class="nx">from</span> <span class="s1">'../dbConnection'</span>
<span class="kr">import</span> <span class="nx">jwt</span> <span class="nx">from</span> <span class="s1">'jsonwebtoken'</span>

<span class="kr">const</span> <span class="nx">login</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Strategy</span><span class="p">({</span>
  <span class="na">usernameField</span><span class="p">:</span> <span class="s1">'email'</span><span class="p">,</span>
  <span class="na">passwordField</span><span class="p">:</span> <span class="s1">'password'</span><span class="p">,</span>
  <span class="na">session</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="na">passReqToCallback</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">},</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">dbConnection</span><span class="p">.</span><span class="nx">Auth</span><span class="p">().</span><span class="nx">findOne</span><span class="p">({</span> <span class="na">email</span><span class="p">:</span> <span class="nx">email</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="p">},</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="p">{</span> <span class="na">message</span><span class="p">:</span> <span class="s1">'Email not found in our database.'</span> <span class="p">})</span>
    <span class="p">}</span>
    <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">isMatch</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isMatch</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="p">{</span>
          <span class="na">sub</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span>
        <span class="p">}</span>
        <span class="kr">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">payload</span><span class="p">,</span> <span class="s1">'just another secret'</span><span class="p">);</span>
        <span class="kr">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
          <span class="na">username</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
          <span class="na">id</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
          <span class="na">id_token</span><span class="p">:</span> <span class="nx">token</span><span class="p">,</span>
          <span class="na">is_Admin</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">isAdmin</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="p">{</span><span class="na">message</span><span class="p">:</span> <span class="s1">'Incorrect password'</span><span class="p">})</span>
    <span class="p">});</span>
  <span class="p">})</span>

<span class="p">})</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">login</span>
</code></pre>
</div>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="c1">//signup stragey</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">Strategy</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'passport-local'</span>
<span class="kr">import</span> <span class="nx">bcrypt</span> <span class="nx">from</span> <span class="s1">'bcrypt-nodejs'</span>
<span class="kr">import</span> <span class="nx">dbConnection</span> <span class="nx">from</span> <span class="s1">'../dbConnection'</span>
<span class="kr">import</span> <span class="nx">jwt</span> <span class="nx">from</span> <span class="s1">'jsonwebtoken'</span>

<span class="kr">const</span> <span class="nx">signup</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Strategy</span><span class="p">({</span>
  <span class="na">usernameField</span><span class="p">:</span> <span class="s1">'email'</span><span class="p">,</span>
  <span class="na">passwordField</span><span class="p">:</span> <span class="s1">'password'</span><span class="p">,</span>
  <span class="na">session</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="na">passReqToCallback</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">},</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">email</span><span class="p">:</span> <span class="nx">email</span><span class="p">.</span><span class="nx">trim</span><span class="p">(),</span>
    <span class="na">password</span><span class="p">:</span> <span class="nx">password</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="nx">dbConnection</span><span class="p">.</span><span class="nx">Auth</span><span class="p">().</span><span class="nx">findOne</span><span class="p">({</span> <span class="na">email</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span> <span class="p">},</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">existingUser</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">existingUser</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="p">{</span> <span class="na">message</span><span class="p">:</span> <span class="s1">'This email is already registered. Please choose a different email address.'</span> <span class="p">})</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">genSalt</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">salt</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> <span class="nx">salt</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">hash</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
          <span class="nx">user</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="nx">hash</span>
          <span class="nx">dbConnection</span><span class="p">.</span><span class="nx">Auth</span><span class="p">().</span><span class="nx">insertOne</span><span class="p">({</span>
            <span class="na">email</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
            <span class="na">password</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">password</span>
          <span class="p">},</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">newUser</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="kr">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="p">{</span>
              <span class="na">sub</span><span class="p">:</span> <span class="nx">newUser</span><span class="p">.</span><span class="nx">_id</span>
            <span class="p">}</span>
            <span class="kr">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">payload</span><span class="p">,</span> <span class="s1">'just another secret'</span><span class="p">);</span>
            <span class="kr">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
              <span class="na">username</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
              <span class="na">id</span><span class="p">:</span> <span class="nx">newUser</span><span class="p">[</span><span class="s1">'ops'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">'_id'</span><span class="p">],</span>
              <span class="na">id_token</span><span class="p">:</span> <span class="nx">token</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
          <span class="p">})</span>
        <span class="p">})</span>
      <span class="p">})</span>
    <span class="p">}</span>
  <span class="p">})</span>

<span class="p">})</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">signup</span>
</code></pre>
</div>

<p>so in server.js, we would have</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">passport</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">'local-signup'</span><span class="p">,</span> <span class="nx">signup</span><span class="p">);</span>
<span class="nx">passport</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">'local-login'</span><span class="p">,</span> <span class="nx">login</span><span class="p">);</span>
<span class="nx">passport</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">'facebook-login'</span><span class="p">,</span> <span class="nx">facebook</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/signup'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span><span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="s1">'local-signup'</span><span class="p">,</span> <span class="p">{</span><span class="na">session</span><span class="p">:</span> <span class="kc">false</span><span class="p">},</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
        <span class="na">message</span><span class="p">:</span> <span class="nx">err</span>
      <span class="p">})</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">info</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">})(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span><span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="s1">'local-login'</span><span class="p">,</span> <span class="p">{</span><span class="na">session</span><span class="p">:</span> <span class="kc">false</span><span class="p">},</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
        <span class="na">message</span><span class="p">:</span> <span class="nx">err</span>
      <span class="p">})</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">info</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">})(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">jwt</span><span class="p">({</span> <span class="na">secret</span><span class="p">:</span> <span class="s1">'just another secret'</span><span class="p">}).</span><span class="nx">unless</span><span class="p">({</span><span class="na">path</span><span class="p">:</span> <span class="p">[</span><span class="s1">'/login'</span><span class="p">,</span> <span class="s1">'/signup'</span><span class="p">,</span>  <span class="s1">'/'</span><span class="p">,</span> <span class="s1">'/favicon.ico'</span><span class="p">]}));</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="mi">401</span> <span class="o">==</span> <span class="nx">err</span><span class="p">.</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="s1">'/login'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>

</code></pre>
</div>

<p>And action-creator would do something like</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kr">export</span> <span class="kr">const</span> <span class="nx">loginUser</span> <span class="o">=</span> <span class="p">(</span><span class="nx">creds</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">method</span><span class="p">:</span> <span class="s1">'POST'</span><span class="p">,</span>
    <span class="na">headers</span><span class="p">:</span> <span class="p">{</span> <span class="s1">'Content-Type'</span><span class="p">:</span><span class="s1">'application/x-www-form-urlencoded'</span> <span class="p">},</span>
    <span class="na">body</span><span class="p">:</span> <span class="err">`</span><span class="nx">email</span><span class="o">=</span><span class="nx">$</span><span class="p">{</span><span class="nx">creds</span><span class="p">.</span><span class="nx">email</span><span class="p">}</span><span class="o">&amp;</span><span class="nx">password</span><span class="o">=</span><span class="nx">$</span><span class="p">{</span><span class="nx">creds</span><span class="p">.</span><span class="nx">password</span><span class="p">}</span><span class="err">`</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">dispatch</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">dispatch</span><span class="p">(</span><span class="nx">requestLogin</span><span class="p">(</span><span class="nx">creds</span><span class="p">))</span>
    <span class="k">return</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">LOGIN_URL</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">user</span> <span class="o">=&gt;</span> <span class="p">({</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">response</span> <span class="p">}))</span>
            <span class="p">).</span><span class="nx">then</span><span class="p">(({</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">response</span> <span class="p">})</span> <span class="o">=&gt;</span>  <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">dispatch</span><span class="p">(</span><span class="nx">loginError</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">message</span><span class="p">))</span>
          <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s1">'id_token'</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id_token</span><span class="p">)</span>
          <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s1">'username'</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">)</span>
          <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s1">'userId'</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
          <span class="nx">dispatch</span><span class="p">(</span><span class="nx">receiveLogin</span><span class="p">(</span><span class="nx">user</span><span class="p">))</span>
          <span class="nx">browserHistory</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="err">`</span><span class="o">/</span><span class="nx">browse</span><span class="err">`</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Error: "</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>My understanding in this is that for a SPA, React-Redux framework for example, app would have two kinds of components: gated and ungated. Gated components would be the ones that requires user log in and display user data; ungated components would be index, login and signup pages. Gated components would have a entry point, since we cannot send JWT to directly get a route. But all API calls should be sent with JWT.</p>

<p>Persistent login is easy with JWT too. Just check if there is JWT stored in localStorage and send it back to authenticate it. So the index page would have something like this:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="c1">// in a React component</span>
<span class="nx">componentDidMount</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">'token'</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">method</span><span class="p">:</span> <span class="s1">'get'</span><span class="p">,</span>
      <span class="na">headers</span><span class="p">:</span> <span class="p">{</span> <span class="s1">'Authorization'</span><span class="p">:</span> <span class="s1">'bear '</span> <span class="o">+</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">'token'</span><span class="p">)}</span>
    <span class="p">}</span>
    
    <span class="nx">fetch</span><span class="p">(</span><span class="nx">AUTH_URL</span><span class="p">,</span> <span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="s1">'401'</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// authentication fails. Clear token</span>
        <span class="nx">localStorage</span><span class="p">.</span><span class="nx">clear</span><span class="p">()</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// Succeed! Go to account page</span>
        <span class="nx">browserHistory</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">'/account'</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">})</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Passport have Facebook login stragegy too. The tricky part is how to get generated JWT. This is what I did:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="c1">// in server.js, send tokens in query string</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/auth/facebook'</span><span class="p">,</span> <span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="s1">'facebook-login'</span><span class="p">));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/auth/facebook/callback'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span><span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="s1">'facebook-login'</span><span class="p">,</span> <span class="p">{</span><span class="na">session</span><span class="p">:</span> <span class="kc">false</span><span class="p">},</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">info</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="err">`</span><span class="o">/</span><span class="nx">login</span><span class="p">?</span><span class="nx">id_token</span><span class="o">=</span><span class="nx">$</span><span class="p">{</span><span class="nx">user</span><span class="p">.</span><span class="nx">id_token</span><span class="p">}</span><span class="o">&amp;</span><span class="nx">username</span><span class="o">=</span><span class="nx">$</span><span class="p">{</span><span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">}</span><span class="o">&amp;</span><span class="nx">id</span><span class="o">=</span><span class="nx">$</span><span class="p">{</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">})(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span>
<span class="p">})</span>

</code></pre>
</div>

<p>And in login component,</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code>
<span class="nx">componentDidMount</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">getParameterByName</span><span class="p">(</span><span class="s1">'id_token'</span><span class="p">)</span> <span class="o">===</span> <span class="s1">'string'</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">id_token</span> <span class="o">=</span> <span class="nx">getParameterByName</span><span class="p">(</span><span class="s1">'id_token'</span><span class="p">)</span>
      <span class="kd">let</span> <span class="nx">username</span> <span class="o">=</span> <span class="nx">getParameterByName</span><span class="p">(</span><span class="s1">'username'</span><span class="p">)</span>
      <span class="kd">let</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">getParameterByName</span><span class="p">(</span><span class="s1">'id'</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">fbLogin</span><span class="p">({</span>
        <span class="nx">id_token</span><span class="p">,</span>
        <span class="nx">username</span><span class="p">,</span>
        <span class="nx">id</span>
      <span class="p">})</span>
    <span class="p">}</span>
    <span class="c1">// fbLogin would dispatch an action that log user in and store all the credentials in localStorage</span>

    <span class="kd">function</span> <span class="nx">getParameterByName</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">url</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">[\[\]]</span><span class="sr">/g</span><span class="p">,</span> <span class="s2">"\\$&amp;"</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">regex</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">"[?&amp;]"</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s2">"(=([^&amp;#]*)|&amp;|#|$)"</span><span class="p">),</span>
          <span class="nx">results</span> <span class="o">=</span> <span class="nx">regex</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">results</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">results</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">return</span> <span class="s1">''</span><span class="p">;</span>
      <span class="k">return</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">results</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">\+</span><span class="sr">/g</span><span class="p">,</span> <span class="s2">" "</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre>
</div>

<h4 id="references">References</h4>
<ol>
  <li><a href="https://auth0.com/blog/secure-your-react-and-redux-app-with-jwt-authentication/">https://auth0.com/blog/secure-your-react-and-redux-app-with-jwt-authentication/</a></li>
  <li><a href="https://vladimirponomarev.com/blog/authentication-in-react-apps-jwt">https://vladimirponomarev.com/blog/authentication-in-react-apps-jwt</a></li>
</ol>

    </div>
  </article>

  <div class="page-navigation">
    
      <a class="page__prev" href="/blog/getter-setter-and-reactivity-in-vue/">&laquo; Getter/Setter and Reactivity in Vue</a>
    
    
      <a class="page__next" href="/blog/async-programming-in-js/">Async Programming in JavaScript &raquo;</a>
    
  </div>
</div>

          </div>
        </main>

        <footer class="footer" id="barba-footer">
  <div class="footer__title">Yao Ding</div>
  <div class="footer__links">
      <a class="footer__link" href="mailto:yaodingyd@gmail.com">Email</a>
      <a  class="footer__link" href="https://github.com/yaodingyd">Github</a>
  </div>
</footer>

<!-- <script src="/public/js/src.js"></script> -->


  </body>
</html>
